name: Build BloxBot

on:
  push:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.9"
  OPENCODE_VERSION: "1.1.53"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            bun_asset: bun-darwin-aarch64.zip
            bun_inner_dir: bun-darwin-aarch64
            bun_bin: bun
            opencode_asset: opencode-darwin-arm64.zip
            opencode_bin: opencode
            ext: ""
            bundle_ext: dmg

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bun_asset: bun-windows-x64.zip
            bun_inner_dir: bun-windows-x64
            bun_bin: bun.exe
            opencode_asset: opencode-windows-x64.zip
            opencode_bin: opencode.exe
            ext: ".exe"
            bundle_ext: msi

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: ${{ matrix.target }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      # ── Download sidecar binaries ──────────────────────────────────

      - name: Download sidecars (macOS)
        if: runner.os == 'macOS'
        run: |
          cd src-tauri/binaries

          curl -fSL --retry 3 --retry-delay 5 -o bun.zip \
            "https://github.com/oven-sh/bun/releases/download/bun-v${{ env.BUN_VERSION }}/${{ matrix.bun_asset }}"
          unzip -o bun.zip
          mv "${{ matrix.bun_inner_dir }}/${{ matrix.bun_bin }}" "bun-${{ matrix.target }}"
          rm -rf bun.zip ${{ matrix.bun_inner_dir }}
          chmod +x "bun-${{ matrix.target }}"

          curl -fSL --retry 3 --retry-delay 5 -o opencode.zip \
            "https://github.com/anomalyco/opencode/releases/download/v${{ env.OPENCODE_VERSION }}/${{ matrix.opencode_asset }}"
          unzip -o opencode.zip
          mv "${{ matrix.opencode_bin }}" "opencode-${{ matrix.target }}"
          rm -f opencode.zip
          chmod +x "opencode-${{ matrix.target }}"

          ls -lh bun-* opencode-*

      - name: Download sidecars (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd src-tauri/binaries

          Invoke-WebRequest -Uri "https://github.com/oven-sh/bun/releases/download/bun-v${{ env.BUN_VERSION }}/${{ matrix.bun_asset }}" -OutFile bun.zip
          Expand-Archive -Path bun.zip -DestinationPath . -Force
          Move-Item -Path "${{ matrix.bun_inner_dir }}/${{ matrix.bun_bin }}" -Destination "bun-${{ matrix.target }}.exe" -Force
          Remove-Item -Recurse -Force bun.zip, ${{ matrix.bun_inner_dir }}

          Invoke-WebRequest -Uri "https://github.com/anomalyco/opencode/releases/download/v${{ env.OPENCODE_VERSION }}/${{ matrix.opencode_asset }}" -OutFile opencode.zip
          Expand-Archive -Path opencode.zip -DestinationPath . -Force
          Move-Item -Path "${{ matrix.opencode_bin }}" -Destination "opencode-${{ matrix.target }}.exe" -Force
          Remove-Item -Force opencode.zip

          Get-ChildItem bun-*, opencode-*

      # ── Build ──────────────────────────────────────────────────────

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: pnpm tauri

      # ── Upload artifacts ───────────────────────────────────────────

      - name: Upload macOS DMG
        if: matrix.bundle_ext == 'dmg'
        uses: actions/upload-artifact@v4
        with:
          name: BloxBot-${{ matrix.target }}
          path: src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error
          retention-days: 14

      - name: Upload Windows MSI
        if: matrix.bundle_ext == 'msi'
        uses: actions/upload-artifact@v4
        with:
          name: BloxBot-${{ matrix.target }}
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn
          retention-days: 14
