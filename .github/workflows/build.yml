name: Build BloxBot

on:
  push:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22.13.1"
  OPENCODE_VERSION: "1.1.53"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            node_asset: node-v22.13.1-darwin-arm64.tar.gz
            node_inner_dir: node-v22.13.1-darwin-arm64
            opencode_asset: opencode-darwin-arm64.zip
            opencode_bin: opencode
            ext: ""
            bundle_ext: dmg
            tauri_args: ""

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            node_asset: node-v22.13.1-win-x64.zip
            node_inner_dir: node-v22.13.1-win-x64
            opencode_asset: opencode-windows-x64.zip
            opencode_bin: opencode.exe
            ext: ".exe"
            bundle_ext: nsis
            tauri_args: "--bundles nsis"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: ${{ matrix.target }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      # ── Download and bundle Node.js runtime ───────────────────────────

      - name: Download Node.js
        shell: bash
        run: |
          curl -fsSL "https://nodejs.org/dist/v${{ env.NODE_VERSION }}/${{ matrix.node_asset }}" -o "/tmp/${{ matrix.node_asset }}"

      - name: Extract Node.js to resources (Unix)
        if: matrix.ext == ''
        shell: bash
        run: |
          cd /tmp
          tar -xzf "${{ matrix.node_asset }}"
          
          # Copy the Node.js distribution to resources (bin + lib/node_modules/npm)
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs"
          cp -R "${{ matrix.node_inner_dir }}/bin" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/"
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/lib/node_modules/npm" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules/"
          
          # Remove corepack (not needed)
          rm -f "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/corepack"
          rm -rf "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules/corepack" 2>/dev/null || true
          
          # Verify structure
          ls -la "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"

      - name: Extract Node.js to resources (Windows)
        if: matrix.ext == '.exe'
        shell: bash
        run: |
          cd /tmp
          unzip -o "${{ matrix.node_asset }}"
          
          # Copy the Node.js distribution to resources
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin"
          cp "${{ matrix.node_inner_dir }}/node.exe" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"
          
          # Create npm/npx batch wrappers that call node with the JS files
          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npm-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npm.cmd"
          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npx-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npx.cmd"
          
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/node_modules/npm" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules/"
          
          # Verify structure
          ls -la "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"

      # ── Download OpenCode sidecar ─────────────────────────────────────

      - name: Download OpenCode sidecar
        run: gh release download "v${{ env.OPENCODE_VERSION }}" -R anomalyco/opencode -p "${{ matrix.opencode_asset }}" -D src-tauri/binaries --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract OpenCode sidecar
        shell: bash
        run: |
          cd src-tauri/binaries
          unzip -o "${{ matrix.opencode_asset }}"
          mv "${{ matrix.opencode_bin }}" "opencode-${{ matrix.target }}${{ matrix.ext }}"
          rm -f "${{ matrix.opencode_asset }}"
          chmod +x "opencode-${{ matrix.target }}${{ matrix.ext }}" 2>/dev/null || true
          ls -lh

      # ── Build ──────────────────────────────────────────────────────

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: pnpm tauri
          args: ${{ matrix.tauri_args }}

      # ── Upload artifacts ───────────────────────────────────────────

      - name: Upload macOS DMG
        if: matrix.bundle_ext == 'dmg'
        uses: actions/upload-artifact@v4
        with:
          name: BloxBot-${{ matrix.target }}
          path: src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error
          retention-days: 14

      - name: Upload Windows installer
        if: matrix.bundle_ext == 'nsis'
        uses: actions/upload-artifact@v4
        with:
          name: BloxBot-${{ matrix.target }}
          path: src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error
          retention-days: 14
