name: Release BloxBot

on:
  push:
    tags: ["v*"]

# Only one release at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  NODE_VERSION: "22.13.1"
  OPENCODE_VERSION: "1.1.53"

jobs:
  build:
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            node_asset: node-v22.13.1-darwin-arm64.tar.gz
            node_inner_dir: node-v22.13.1-darwin-arm64
            opencode_asset: opencode-darwin-arm64.zip
            opencode_bin: opencode
            ext: ""
            bundle_ext: dmg
            tauri_args: ""

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            node_asset: node-v22.13.1-win-x64.zip
            node_inner_dir: node-v22.13.1-win-x64
            opencode_asset: opencode-windows-x64.zip
            opencode_bin: opencode.exe
            ext: ".exe"
            bundle_ext: nsis
            tauri_args: "--bundles nsis"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: ${{ matrix.target }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      # ── Download and bundle Node.js runtime ───────────────────────────

      - name: Download Node.js
        shell: bash
        run: |
          curl -fsSL "https://nodejs.org/dist/v${{ env.NODE_VERSION }}/${{ matrix.node_asset }}" -o "/tmp/${{ matrix.node_asset }}"

      - name: Extract Node.js to resources (Unix)
        if: matrix.ext == ''
        shell: bash
        run: |
          cd /tmp
          tar -xzf "${{ matrix.node_asset }}"
          
          # Copy node binary + npm lib (not symlinks — Tauri flattens them)
          DEST="$GITHUB_WORKSPACE/src-tauri/resources/nodejs"
          mkdir -p "$DEST/bin"
          cp "${{ matrix.node_inner_dir }}/bin/node" "$DEST/bin/"
          mkdir -p "$DEST/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/lib/node_modules/npm" "$DEST/lib/node_modules/"
          
          # Create shell wrapper scripts (not symlinks) for npm/npx
          printf '#!/bin/sh\nbasedir=$(dirname "$(realpath "$0")")\nexec "$basedir/node" "$basedir/../lib/node_modules/npm/bin/npm-cli.js" "$@"\n' > "$DEST/bin/npm"
          printf '#!/bin/sh\nbasedir=$(dirname "$(realpath "$0")")\nexec "$basedir/node" "$basedir/../lib/node_modules/npm/bin/npx-cli.js" "$@"\n' > "$DEST/bin/npx"
          chmod +x "$DEST/bin/npm" "$DEST/bin/npx"
          
          ls -la "$DEST/bin/"

      - name: Extract Node.js to resources (Windows)
        if: matrix.ext == '.exe'
        shell: bash
        run: |
          cd /tmp
          unzip -o "${{ matrix.node_asset }}"
          
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin"
          cp "${{ matrix.node_inner_dir }}/node.exe" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"
          
          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npm-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npm.cmd"
          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npx-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npx.cmd"
          
          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/node_modules/npm" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules/"
          
          ls -la "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"

      # ── Download OpenCode sidecar ─────────────────────────────────────

      - name: Download and extract OpenCode sidecar
        shell: bash
        run: |
          mkdir -p src-tauri/binaries
          curl -fSL --retry 3 --retry-delay 5 \
            "https://github.com/anomalyco/opencode/releases/download/v${{ env.OPENCODE_VERSION }}/${{ matrix.opencode_asset }}" \
            -o "/tmp/${{ matrix.opencode_asset }}"
          cd src-tauri/binaries
          unzip -o "/tmp/${{ matrix.opencode_asset }}"
          mv "${{ matrix.opencode_bin }}" "opencode-${{ matrix.target }}${{ matrix.ext }}"
          rm -f "/tmp/${{ matrix.opencode_asset }}"
          chmod +x "opencode-${{ matrix.target }}${{ matrix.ext }}" 2>/dev/null || true
          ls -lh

      # ── Build ──────────────────────────────────────────────────────

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: pnpm tauri
          args: ${{ matrix.tauri_args }}

      # ── Stage artifacts for upload ──────────────────────────────────

      - name: Upload macOS DMG
        if: matrix.bundle_ext == 'dmg'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Upload Windows installer
        if: matrix.bundle_ext == 'nsis'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

  # ── Create GitHub Release with all platform artifacts ──────────────

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true

      - name: List artifacts
        run: ls -lhR artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: BloxBot ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
          generate_release_notes: true
          files: artifacts/*
          body: |
            ## Download

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | `BloxBot_*_aarch64.dmg` |
            | Windows (64-bit) | `BloxBot_*_x64-setup.exe` |

            ### Installation

            **macOS**: Open the `.dmg`, drag BloxBot to Applications. On first launch, right-click → Open to bypass Gatekeeper (the app is not yet code-signed with an Apple Developer certificate).

            **Windows**: Run the `.exe` installer. If SmartScreen warns about an unknown publisher, click "More info" → "Run anyway" (the app is not yet code-signed).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
