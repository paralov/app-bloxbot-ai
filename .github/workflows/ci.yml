name: CI / Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

env:
  NODE_VERSION: "22.13.1"
  OPENCODE_VERSION: "1.1.53"

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: ${{ startsWith(github.ref, 'refs/tags/') }}
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            node_asset: node-v22.13.1-darwin-arm64.tar.gz
            node_inner_dir: node-v22.13.1-darwin-arm64
            opencode_asset: opencode-darwin-arm64.zip
            opencode_bin: opencode
            ext: ""
            args: ""

          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            node_asset: node-v22.13.1-win-x64.zip
            node_inner_dir: node-v22.13.1-win-x64
            opencode_asset: opencode-windows-x64.zip
            opencode_bin: opencode.exe
            ext: ".exe"
            args: "--bundles nsis"

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: ${{ matrix.target }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      # ── Download and bundle Node.js runtime ───────────────────────────

      - name: Download Node.js
        shell: bash
        run: |
          curl -fsSL "https://nodejs.org/dist/v${{ env.NODE_VERSION }}/${{ matrix.node_asset }}" -o "/tmp/${{ matrix.node_asset }}"

      - name: Extract Node.js to resources (Unix)
        if: matrix.ext == ''
        shell: bash
        run: |
          cd /tmp
          tar -xzf "${{ matrix.node_asset }}"

          DEST="$GITHUB_WORKSPACE/src-tauri/resources/nodejs"
          mkdir -p "$DEST/bin"
          cp "${{ matrix.node_inner_dir }}/bin/node" "$DEST/bin/"
          mkdir -p "$DEST/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/lib/node_modules/npm" "$DEST/lib/node_modules/"

          printf '#!/bin/sh\nbasedir=$(dirname "$(realpath "$0")")\nexec "$basedir/node" "$basedir/../lib/node_modules/npm/bin/npm-cli.js" "$@"\n' > "$DEST/bin/npm"
          printf '#!/bin/sh\nbasedir=$(dirname "$(realpath "$0")")\nexec "$basedir/node" "$basedir/../lib/node_modules/npm/bin/npx-cli.js" "$@"\n' > "$DEST/bin/npx"
          chmod +x "$DEST/bin/npm" "$DEST/bin/npx"

      - name: Extract Node.js to resources (Windows)
        if: matrix.ext == '.exe'
        shell: bash
        run: |
          cd /tmp
          unzip -o "${{ matrix.node_asset }}"

          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin"
          cp "${{ matrix.node_inner_dir }}/node.exe" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/"

          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npm-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npm.cmd"
          printf '@echo off\r\n"%%~dp0node.exe" "%%~dp0..\\lib\\node_modules\\npm\\bin\\npx-cli.js" %%*\r\n' > "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/bin/npx.cmd"

          mkdir -p "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules"
          cp -R "${{ matrix.node_inner_dir }}/node_modules/npm" "$GITHUB_WORKSPACE/src-tauri/resources/nodejs/lib/node_modules/"

      # ── Download OpenCode sidecar ─────────────────────────────────────

      - name: Download and extract OpenCode sidecar
        shell: bash
        run: |
          mkdir -p src-tauri/binaries
          curl -fSL --retry 3 --retry-delay 5 \
            "https://github.com/anomalyco/opencode/releases/download/v${{ env.OPENCODE_VERSION }}/${{ matrix.opencode_asset }}" \
            -o "/tmp/${{ matrix.opencode_asset }}"
          cd src-tauri/binaries
          unzip -o "/tmp/${{ matrix.opencode_asset }}"
          mv "${{ matrix.opencode_bin }}" "opencode-${{ matrix.target }}${{ matrix.ext }}"
          chmod +x "opencode-${{ matrix.target }}${{ matrix.ext }}" 2>/dev/null || true

      # ── Build MCP server (submodule) and launcher ──────────────────

      - name: Build MCP server
        shell: bash
        run: |
          cd src-tauri/resources/mcp-server
          npm install
          npm run build
          # Keep only production deps for the bundle
          rm -rf node_modules
          npm install --omit=dev --no-package-lock

      - name: Build MCP launcher
        shell: bash
        run: |
          cd src-tauri/resources/launcher
          npm install
          npm run build

      # ── Build (CI) / Build & Release (tags) ─────────────────────────

      - name: Build and optionally release
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tauriScript: pnpm tauri
          args: ${{ matrix.args }}
          # Only set on tags — omitting these on non-tag builds makes
          # tauri-action build without creating a release.
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/') && format('BloxBot {0}', github.ref_name) || '' }}
          releaseBody: |
            ## Download

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | `BloxBot_*_aarch64.dmg` |
            | Windows (64-bit) | `BloxBot_*_x64-setup.exe` |

            ### macOS — Gatekeeper

            Since the app is not signed with an Apple Developer certificate, macOS will block it on first launch. To open it:
            1. Open the `.dmg` and drag **BloxBot** to Applications.
            2. Try to open BloxBot — macOS will show a warning and block it.
            3. Open **System Settings → Privacy & Security**, scroll down, and click **Open Anyway**.
            4. Confirm in the dialog that reappears.

            After this, BloxBot will open normally like any other app.

            ### Windows — SmartScreen

            The installer is not yet code-signed, so Windows SmartScreen may show a warning:
            1. Run the `.exe` installer.
            2. If you see "Windows protected your PC", click **More info**.
            3. Click **Run anyway**.
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
          updaterJsonPreferNsis: true

      # Upload build artifacts for CI runs (not needed for releases since
      # tauri-action already attaches them to the GitHub Release).
      - name: Upload build artifacts
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: bloxbot-${{ matrix.target }}
          path: "${{ join(fromJSON(steps.tauri.outputs.artifactPaths), '\n') }}"
